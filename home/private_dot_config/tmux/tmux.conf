###################
# Documentation
###################

# set is the alias of set-option
#  -g is used to set global option
#  -ga appends values to existing settings
#  -w window option
#  -p pane option

# set -s controls options which do not apply to any particular session or pane
#  you can list those with show-options -s

###################
# Look and feel
###################

# Set the default terminal mode to 256color
# requires to edit $HOME/.config/alacritty/alacritty.yml
#
# env:
#   TERM: alacritty-direct
#

set -g default-terminal "tmux-256color"

# Define terminal overrides
#----------------------------
# Use generic `*`, because `tmux info` doesn't report `tmux-256color`

# Enable 24-bit color support
# test with `tmux info | grep Tc`
set -sa terminal-overrides ",*:Tc"
set -sa terminal-overrides ',*:RGB'
# Add Italics
# test with `echo -e "\e[3mfoo\e[23m"`
set -sa terminal-overrides ',*:sitm=\E[3m'

# Add Undercurl
#<ESC>[4:0m  # no underline
#<ESC>[4:1m  # straight underline
#<ESC>[4:2m  # double underline
#<ESC>[4:3m  # curly underline
#<ESC>[4:4m  # dotted underline
#<ESC>[4:5m  # dashed underline
#<ESC>[4m    # straight underline (for backwards compat)
#<ESC>[24m   # no underline (for backwards compat)
#
# I needed to also edit my terminfo
#
#   infocmp > /tmp/$TERM.ti
#   Add Smulx=\E[4\:%p1%dm, after smul=\E[4m,
#   tic -x /tmp/$TERM.ti
# to make it work in neovim
#
# see also https://dev.to/jibundit/undercurl-display-on-neovim-and-tmux-with-iterm2-3pi0
#
# test with `printf '\e[4:3mUndercurl\n\e[0m'`
set -sa terminal-overrides ',*:Smulx=\E[4::%p1%dm'
# Add colored undercurl
#   \e[58:2:206:134:51m is the escape sequence to color the underline.
#   58 says this will be about underline colors,
#   2 says the following values will be RGB, and then 206:134:51 are said RGB values
# test with `printf '\e[4:3m\e[58:2:206:134:51mUnderlined\n\e[0m'`
# see https://ryantravitz.com/blog/2023-02-18-pull-of-the-undercurl/
set -sa terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'

####################
# Statusline
###################
set -g status on
set-option -g status-interval 5

# match black menu bar of macos
set-option -g status-position top
set-option -g status-style fg=colour15,bold,bg=colour16

# we assume a window width of ~145 characters
#   echo -e "cols"|tput -S
#   143
set -g status-left-length 70
set -g status-left '#S #(gitmux "#{session_path}")'

set -g status-right-length 70
set -g status-right ' #(~/.config/tmux/fzf_sessions.fish sessions) 󰌃 #(~/.config/tmux/jira_tickets.fish "#{session_path}")  #(~/.config/tmux/github_prs.fish "#{session_path}")'

set-option -g status-justify absolute-centre
set -g window-status-current-format '#[fg=green]#W'
set -g window-status-format         '#[fg=gray]#W'

# draw black background to hide notch in fullscreen
set-option -g status-format[1] "#[fill=colour16]"

###################
# Configuration
###################

set-option -g default-shell /opt/homebrew/bin/fish

# don't exit from tmux when closing a session
set -g detach-on-destroy off

# Rather than constraining window size to the maximum size of any client
# connected to the *session*, constrain window size to the maximum size of any
# client connected to *that window*
set-option -w -g aggressive-resize on

# Enable mouse support
set -g mouse on

# Start numbering at 1, 0 is too far from `
set -g base-index 1
set-window-option -g pane-base-index 1

# Ensure window index numbers get reordered on delete.
set-option -g renumber-windows on

# Allows for faster key repetition
# address vim mode switching delay (http://superuser.com/a/252717/65504)
set -s escape-time 0

# New windows in same path
bind c new-window -c "#{pane_current_path}"

# More scrollback-size, more history
set-option -g history-limit 30000
#
# allow to pass on focus events to vim inside of tmux
# needed as on tmux 1.9 and up (defaults to off)
# added in tmux commit c7a121cfc0137c907b7bfb
set -g focus-events on

###################
# Key bindings
###################

# Horizontal split
unbind %
bind | split-window -h -c "#{pane_current_path}"

# Vertical split
unbind '"'
bind - split-window -v -c "#{pane_current_path}"

# Use Alt-arrow keys without prefix key to resize panes
bind -n M-Left resize-pane -L 1
bind -n M-Right resize-pane -R 1
bind -n M-Up resize-pane -U 1
bind -n M-Down resize-pane -D 1

# Shift arrow to switch windows
bind -n S-Left  previous-window
bind -n S-Right next-window

# Rerrange windows
bind-key -n C-S-Left swap-window -t -1
bind-key -n C-S-Right swap-window -t +1

# Use vim keybindings in copy mode
setw -g mode-keys vi

# Setup 'v' to begin selection as in Vim
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi Escape send-keys -X cancel
bind-key -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "pbcopy"

# Update default binding of `Enter` to also use copy-pipe
unbind -T copy-mode-vi Enter
bind-key -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "pbcopy"

# Reload configuration with `prefix, r`
bind-key r source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded"

# show session chooser
bind -n C-Space display-popup -h 33%  -w 33% -E "$HOME/.config/tmux/fzf_sessions.fish search"

# switch session with C-[Left|Right]]
bind-key -n C-Right switch-client -n
bind-key -n C-Left  switch-client -p

####################
# Plugins
####################

# Install:
#   1. add set -g @plugin '...'
#   2. prefix + I
# Uninstall:
#   1. remove set -g @plugin '...'
#   2. prefix + alt + u
# Update:
#   1. prefix + U

set -g @plugin 'tmux-plugins/tpm'               # tmux plugin manager
set -g @plugin 'christoomey/vim-tmux-navigator' # navigatet  between tmux panes and vim splits
set -g @plugin 'joshmedeski/tmux-nerd-font-window-name' # nerd font icons for window status

# extrakto
# ------------------

set -g @plugin 'laktak/extrakto'                # fuzzy select/copy/open withut mouse
set -g @extrakto_grab_area "window full"
set -g @extrakto_split_direction "v"
set -g @extrakto_split_size "10"
set -g @extrakto_copy_key "tab"
set -g @extrakto_insert_key "enter"

# resurrect
# ------------------
# persist tmux environments (and optionally more eg. nvim)
# prefix + Ctrl-s - save
# prefix + Ctrl-r - restore

set -g @plugin 'tmux-plugins/tmux-resurrect'

# continuum
# ------------------
# automatically, contiually saves tmux environment

set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on' # restore last save upon first tmux start

########################
# Bootstrapping
########################

if "test ! -d ~/.config/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"

run -b '~/.config/tmux/plugins/tpm/tpm'
run-shell ~/.config/tmux/plugins/tmux-resurrect/resurrect.tmux
